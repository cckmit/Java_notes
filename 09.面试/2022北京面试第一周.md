# 一、学习

4月5日
MySQL数据库
MyCat



## 1网关服务

请求转发
网关将请求转发给相应的微服务，配置如下：
（1）- StripPrefix=1：转发的时候将第一个前缀去掉
（2）http://localhost:8002/goods/sku/100000022652请求根据goods前缀转发到商品服务，其中8002是网关端口。






是的

















跨域问题

Origin重复的问题：参考文章

（1）将所有后端服务的跨域处理都去除，交网关统一处理。
（2）强烈建议阅读一下类org.springframework.cloud.gateway.filter.factory.DedupeResponseHeaderGatewayFilterFactory上的注释，比官方文档写得还好。
Spring Cloud Greenwich SR2提供的新特性，低于这个版本无法使用。

（3）网关中统一配置跨域如下

























## 2日志服务

通过aop记录日志实现思路
前端发起业务模块增删改查请求时，通过AOP拦截请求的类、方法、参数组装日志数据，通过Feign调用日志微服务记录日志。然后返回结果。
通过自定义注解，feign调用日志服务接口，来记录日志。
（1）自定义注解
（2）定义注解解析类
（3）定义feign接口
（4）需要记录日志的地方添加注解

日志表的ID生成：分布式ID（雪花算法）
之所以日志表没有设置成主键自增，是因为这张表的数据量可能会很大。大到一个服务器的磁盘存储不下，后续会使用mycat分片，水平拆分，这个时候如果采用主键自增就会发生主键冲突。我们使用分布式ID（一个long型的ID），可以保证分布式集群环境下不会重复。

任意微服务想要记录日志
步骤：
（1）拷贝cn.itcast.goods.aop包，修改OperateAdvice中@Around("execution(* cn.itcast.order.controller.*.*(..)) && @annotation(operateLog)")对应内容
（2）启动类上添加注解@EnableFeignClients(basePackages = "cn.itcast.feign.client")，开启feign远程调用并开启包扫描
（3）在需要记录日志的接口上添加注解@OperateLog
日志服务接入网关
网关配置文件中配置：





## 3 MyBatis

字段映射resultMap
实体类（驼峰命名）和数据库中表字段（下划线分割）并不对应，所以需要进行字段映射












动态sql
















4 PageHelper设置分页
使用如下：

























## 5 注解总结

@RequestBody Map dataMap
@PathVariable Integer page

@RestController
@Autowired
@RequestMapping("/search/{page}/{size}")





## 6 MyCat

使用MyCat来进行数据库分片
垂直拆分（各个数据库中存储的表结构是不一样的）
将同一块业务的数据库表拆分到同一个数据库服务中，分为：
数据库1：商品模块表
数据库2：订单模块表
数据库3：日志模块表

全局表（冗余全局信息）
由于省、市、区县、数据字典表，在订单及商品等模块中都需要用到，还会涉及到多表连接查询，那么这个时候涉及到跨库的join操作，可以使用全局表来解决。
即将省市区县和数据字典这4张表冗余到每一个数据库中。

水平拆分（日志）
每天都会产生大量的用户操作日志。对日志表进行水平拆分，分为：
数据库1：商品模块表、基础信息表
数据库2：订单模块表、基础信息表
数据库3：日志模块表、基础信息表
数据库4：日志模块表、基础信息表

重要概念
逻辑库
逻辑表
数据结点
全局表



分片规则（水平拆分）
一致性hash算法（本案例采用的）：根据主键ID的hash值来决定分散在哪个节点上
取模分片



总结
操作mysql一样操作mycat。配置好以后，只需要将原有mysql连接改为mycat连接即可。

## 7 MySQL相关

说明：
1 一定要掌握的重心：索引、锁、事务和隔离级别




SQL基础
1 DDL（库表字段定义）、DML（表的增删改）、DQL（表的查询）、DCL（访问权限控制）
















从上面我们也可以看到MySQL常用的数据类型。

2 查询中用到的关键词主要包含六个，顺序依次为
Select
要查询字段 / 聚合函数（count、max、min、avg、sum）
from
where（条件）
group by（分组）
having
order by（排序）
limit 2,4（分页）（从第2条记录开始的4条记录，记录从0开始）（起始索引 查询记录数）

3 约束（保证数据的完整性和正确性）和外键约束




外键约束：外键用来让两张表的数据之间建立连接，从而保证数据的一致性和完整性。如员工表关联部门表的id



4 多表查询（多表关系、内连接、左外连接、子查询）
通过where条件来消除笛卡尔积

5 数据库设计三大范式（1NF、2NF、3NF）

每列不可拆分；一张表只做一件事；满足2NF下消除表中的传递依赖。

在进行数据库设计时，首先要确保表结构要达到第三范式的要求。但在实际开发时，为满足业务的需要，会在符合三范式的表中加入冗余字段，结果导致不符合第三范式的要求。

这时要注意关系维护。（比如部门表修改了，员工表中数据要对应修改，否则不一致产生错误）







索引
MySQL 5.5 之后，InnoDB是默认的 MySQL 存储引擎（基于表的）
- 事务
- 行级锁，提高并发访问性能
- 支持外键 FOREIGN KEY约束，保证数据的完整性和正确性

1 索引的理解（是什么、优缺点）
索引index是帮助MySQL高效获取数据的数据结构（有序），可以加快数据查询速度。
优点：提高查询速度降低数据库I/O成本；降低排序成本降低CPU消耗。
缺点：存储成本；降低了更新（增删改时索引要重建）效率。

2 索引结构--为什么InnoDB存储引擎选择使用B+tree索引结构?（即和另外3种进行对比）
为什么不用二叉树/红黑树？
大数据量下，层级较深，检索速度慢。
为什么不使用B树？
相比B+树非叶子结点也存储数据，相比B+树高度更高，性能降低。
为什么不用哈希表？
B+tree支持范围匹配及排序操作

总结一下B+树索引数据结构的优点：
（1）所有数据出现在叶子结点，叶子结点形成一个单向链表
（2）MySQL索引数据结构对经典的B+Tree进行了优化，增加了一个链表指针形成双向链表，提高了区间访问性能。
3 索引类型（主要谈聚集索引和二级索引、回表）
分类：主键索引、唯一索引、常规索引、全文索引
InnoDB中按照存储形式分为聚集索引和二级索引。

对于聚集索引：
（1）存在主键，主键索引就是聚集索引。不存在主键存在唯一索引，将其作为聚集索引。都没有就生成一个隐藏的rowid作为聚集索引。
（2）叶子结点挂的是完整的一行数据


对于二级索引：
（1）如上图，如果针对name字段再建立一个索引，因为聚集索引只会有一个，所以name字段建的索引称为二级索引。叶子结点下面挂的是name值对应的这一行的的主键值

对于回表：
select * from user where name = 'arm';
（1）以上sql不会走聚集索引，会走二级索引
（2）A比L小，到Geek，再到Arm，拿到10。要获取所有数据，再根据聚集索引查找。这一过程称为回表查询：先走二级索引找到对应的主键值，再根据主键值到聚集索引中拿到这一行的行数据。

聚集索引和二级索引的结构一定要理解，这个在SQL优化中是非常重要的。很多SQL优化策略的底层原理。

## 4 sql性能分析/优化、索引使用原则/正确使用、索引失效

根据慢查询日志定位慢查询sql -> explain查看执行计划 -> 修改sql或让sql尽量走索引

如上执行计划，重要字段如下：
（1）Id: 执行select子句或者是操作表的顺序（id大先执行，id相同的从上到下执行）
（2）type：表示连接类型，性能由好到差的连接类型为NULL、system、const（主键或唯一索引）、eq_ref、ref（非唯一性索引）、range、 index、all （全表扫描，性能低）。 （尽量往前优化！）
（3）possible_key：显示可能应用在这张表上的索引，一个或多个。
（4）Key：实际使用的索引，如果为NULL，则没有使用索引。
（5）Key_len：表示索引中使用的字节数， 该值为索引字段最大可能长度，并非实际使用长度，在不损失精确性的前提下， 长度越短越好 。


索引的使用/SQL优化
建议最左前缀法则
业务允许的话，建议使用>=；不建议在索引上进行列运算
建议字符串加引号；不建议头部模糊匹配
建议or连接的各条件都有索引
建议使用覆盖索引（返回的列在索引中都能找到，减少select *使用以避免回表扫描）
建议针对长度大的字段建立前缀索引
建议建立联合索引而非单列索引（多个查询条件下）

执行update语句的时候，一定要根据索引字段进行更新，否则行锁升级为表锁。


- 建议  针对查询频繁的表建立索引
- 建议  常作为查询条件（where）、排序（order by）、分组（group by）操作的字段建立索引
- 建议  联合索引很多时候可以覆盖索引，节省存储空间，避免回表，提高查询效率。
- 建议  选择区分度高（身份证号，反例是性别）的列建立索引
- 建议  控制索引数量



锁（解决并发访问问题）
全局锁、表级锁、行级锁（锁定粒度最小）

对于行级锁
InnoDB的行锁是针对于索引加的锁，不通过索引条件检索数据，那么InnoDB将对表中的所有记录加锁，此时就会升级为表锁。





对于悲观锁和乐观锁
从程序员的角度看，数据库中的锁又可以分为悲观锁和乐观锁。
- 悲观锁：利用数据库的锁机制实现，在整个数据处理过程中都加入了锁，以保持排他性。
- 乐观锁：乐观锁可以利用CAS实现，在操作数据的时候进行一个比较，按照当前事务中的数据和数据库表中的该数据是否一致来决定是否要执行本次操作。





事务和隔离级别
事务概念
事务的4大特性



并发事务问题



事务隔离级别：读未提交、读已提交、可重复读（默认）、虚幻读





InnoDB引擎
逻辑存储结构
依次为：表空间、段、区、页、行



架构（内存 + 磁盘）
内存架构
（1）缓冲池 Buffer Pool
（2）缓冲池 Buffer Pool
（3）自适应Hash（系统完成，无需人工干预）
（4）日志缓冲区Log Buffer（保存要写入磁盘的log日志数据）




磁盘架构
（1）主要是Redo log重做日志。事务提交之后修改数据存储到改日志中，实现事务持久性。

后台线程（日志缓冲区Log Buffer）




事务管理

undo log（原子性）：回滚日志，记录数据修改前的信息，作用是回滚和MVCC（指维护一个数据的多个版本，使得读写操作没有冲突）


redo log（持久性）：重做日志，记录事务提交时的修改信息












分库分表、主从复制、读写分离（参考第6点的案例）



如下，双主双从读写分离







## 8 统一网关Gateway

网关功能：
身份认证和权限校验
服务路由、负载均衡
请求限流


在SpringCloud中网关的实现包括两种：
- gateway
- zuul
Zuul是基于Servlet的实现，属于阻塞式编程。而SpringCloud Gateway则是基于Spring5中提供的WebFlux，属于响应式编程的实现，具备更好的性能。



GatewayFilter是网关中提供的一种过滤器，可以对进入网关的请求和微服务返回的响应做处理。



## 9 微服务面试

SpringCloud常见组件有哪些？

SpringCloud包含的组件很多，有很多功能是重复的。其中最常用组件包括：
注册中心组件：Eureka、Nacos等
负载均衡组件：Ribbon
远程调用组件：OpenFeign
网关组件：Zuul、Gateway
服务保护组件：Hystrix、Sentinel
服务配置管理组件：SpringCloudConfig、Nacos


Nacos如何避免并发读写冲突问题？

Nacos在更新实例列表时，会采用CopyOnWrite技术，首先将旧的实例列表拷贝一份，然后更新拷贝的实例列表，再用更新后的实例列表来覆盖旧的实例列表。
这样在更新的过程中，就不会对读实例列表的请求产生影响，也不会出现脏读问题了。

## 10 Java基础、多线程并发



## 11 Spring框架



## 12 分布式

## 13 高并发&高可用



## 14 工具

## 15 项目问题

线上问题案例或者系统性能优化











## 16 中科项目资料

环境准备
操作系统	Linux
JAVA环境	jdk1.8
Redis服务端	下载官网最新linux版本，并根据官方指导安装，可根据需要启动单机redis服务端或搭建redis集群
数据库初始化	如果是第一次上线的系统，根据数据库类型，执行建表脚本和数据初始化脚本；如果是已上线运行的系统，则执行增量脚本


服务介绍

	服务名	名称	说明

框架基础服务	eureka	注册中心	提供其它服务的注册能力
	gateway	网关服务	前后端请求统一路由管理
	oauth2	认证服务	提供用户登录认证功能，连接frame库
平台基础服务	framework-server2	框架配置基础服务	提供平台配置的基本功能后台服务，连接frame库
	framework-engin2	框架配置数据运行期查询服务	提供平台大部分配置数据的运行期数据查询的服务，连接frame库
	element-server2		提供基础数据相关的配置和数据查询的服务，连接element库
	framework-web2	平台V2.X版本前端服务	平台V2.X版本的配置页面
	gap3	平台V3.X版本前端服务	平台V3.X版本的配置页面
其他	billtype-server	单据服务	提供单据中心配置和单据视图相关的运行期接口查询


平台其它V2.X版本服务不在本次服务部署和更新范围内。
服务运行时先启动注册中心和redis，其它服务若无启动过程中的程序处理依赖，则不区分启动顺序。



# 二、面试

## 1 天阳科技（智联）（4月8日晚6：30）（电话20min）

- 自我介绍

- 介绍项目，负责内容

```bash
上家公司主要做财政一体化系统。为全国各个省市区县财政预算提供支持。
业务上，分财政区划（也就是省市区县、银联分公司4大级别）和业务年度（默认是当前年度）。比如江苏省财政厅、南京市财政局。为其预算执行的一些环节提供支持。平台系统在各个地方的差异主要是版本和数据库的不同。系统的核心概念主要有：用户角色功能菜单菜单组。
技术上，基于springcloud微服务架构，使用Oracle / mysql 等关系型数据库以及Redis等非关系型数据库。使用Eureka/Nacos注册中心配置中心，gateway网关outh2认证，基于feign实现服务间接口调用，封装的JdbcTemplate和Mybatis这2种方式进行持久层操作。基于Sentinel实现服务降级和保护。

我负责的主要有：操作日志的记录。新版本搭建和开发。单独实现的和其它部门对接的服务4A。
```

- 日志实现（每一个需要记录日志的类都加上注解？）监听器，记录哪些信息

```bash
通过自定义注解，配合切面扫描，获取session中的信息进而补充日志信息，通过发布事件进而执行监听器中的日志记录方法。
练习：完成用户注册与发送短信之间的解耦, 用事件方式、和 AOP 方式分别实现

AOP实现之代理Proxy（jdk和proxy代理）
```

- MyBatis中dao和xml关系指定

- 常用注解   
  - @RequestParam注解的作用，可以不用吗
  - 接收查询参数，可以不用，spring使用的是同一个参数解析器。

- Spring的容器

```bash
run( )方法返回的ConfigurableApplicationContext，继承了ApplicationContext接口（继承了4个接口，相比BeanFactory多的功能）
BeanFactory才是Spring 的核心容器，表面上只有getBean方法，实际各种功能都由其实现类提供。
```



- 数据库入库实现，自己使用的BaseDao具体是否有研究
  - 连接池实现，连接数？
  - Druid 

- 数据量大概多少？数据库中数据的量，接触过生产环境？
  - 几十万不到一百万，省市的业务管理员（用户）。说说分库分表
  - 出差接触了一个月



## 2 厚德财付通科技（周一早上9:30）（线下东城区）

### 笔试（逻辑测试、性格测试）

### 技术面试（技术leader和人事hr）

- maven jar 原理、问题处理

- 常用注解

### 复试



## 3 北京微视听文化传媒有限公司（周一下午2:30）（线下丰台区）（通过）

erp

转go和python

不匹配

## 4 北京深维智信科技有限公司  笔试（周一晚上8点）

放弃

## 5 开科唯识（周二早上9：30）（海淀区）

放弃

## 6 复试（周二下午1：30）

### 技术总负责人和老板

核心就是问规划

## 7 轻而易举（周二下午3点）（朝阳区三里屯）

### 笔试：实现编译器解释器

### 技术面试

聊了聊西安的大学，气候

Sql：存储过程、索引、B+树

跨域、跨域的处理

说说线程和进程、为什么使用多线程、几种实现方式

Git命令   git checkout -b、MQ使用场景、final关键字

### 技术复试

## 8 方图数据人事面试（周三下午2点）（电话）

距离较远、班车

似乎有笔试、线上

1面电话

## 9 中科汇联技术面试（周三下午3点腾讯会议）


IO流的类说出10个

多线程创建方式、项目使用

微服务事务

mysql和Oracle语法差异、设计

设计表结构类型层级复制、递归（没太听懂）

网关做了什么，认证做了什么（假如是黑客破解了，如何防止url跳转访问）

Mybatis   like那里怎么写    

两种取值方式的区别

@RestController和@Controller，上传下载文件用哪个

## 10 久其（周三晚上8点半）

## 11 芯际国际（周四早10点)（海淀区清河）（Java和go结合）

### 一道算法题

旋转矩阵

做出来了，做的有点久40多分钟，代码需要优化。

### 笔试：数学+类比选择题40道

数学能力发挥出来了（数学的都对了，类比的错了一些）

### 技术面试

算法题的思路

异常、多线程、spring部分、多SE部分内容

### 技术总负责人复试（北航科班）

算法题、笔试部分题目

数学、学习过程

区块链、发展

## 12 易游时代（周四下午2点半）（游戏开发）（通过）

### 笔试（字符串、模式匹配 、写SQL等好多题目）

### 技术面试

负载均衡、网络、HTTP、TCP

多线程、MQ、Linux、SQL

### 老板复试

中值定理、乱七八糟聊了快一个小时

## 13 数因科技（周五下午2点）

## 14 方图数据（周五下午3点15）（复试未进行）

## 15 会小二（周六早上10点线上笔试）（自己放弃）



1. 问题: 给出一个包含括号和小写英文字符的字符串。 去掉无效（无法匹配组成整对的括号）的字符左括号'('或者右括号")"，使得输出

   的结果字符串仅包含有效的字符(成对的括号和英文字符)。 样例如下：



```java
Input: s = "h)u(i)xiaoer"
Output: "hu(i)xiaoer"

Expectation) O(N) O(N)

Entry)

 public String minRemoveToMakeValid(String str) {

  
   return str; 

}

Edge cases)

Input: s = "hu((i(x(i(ao(er"

Output: "huixiaoer"

（要求包含unit，test ，testcase）
```



<br>

2. 输入n 个整数，输出其中最小的k 个。如给定 {1, 12, 10, 9, 8, 6} k 选择 3 则输出：{1, 6, 8}



<br>

3. LRU 的实现，时间复杂度是 O(1) ， Example:

```java
LRUCache cache = new LRUCache( 2 /* capacity */ );
 cache.put(1, 1);
 cache.put(2, 2);
 cache.get(1); // returns 1 
 cache.put(3, 3); // evicts key 2
 cache.get(2); // returns -1 (not found)
 cache.put(4, 4); // evicts key 1 
 cache.get(1); // returns -1 (not found)
 cache.get(3); // returns 3 
 cache.get(4); // returns 4
（要求包含unit，test ，testcase）
```



4. 设计一个门票限时销售系统。（包含系统架构图，业务流程图，并合理的自由发挥）



流程图请在这里上传（支持 png jpg 格式）。



## 16 中科汇联复试（周二下午）

## 17 方图数据复试（未进行）



# 三、总结

- 平时多思考、多积累技能点（和亮点）
- 面试完及时记录、总结



















